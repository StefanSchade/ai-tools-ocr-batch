= Developer Guide

== Abstract



== Developing in a Container

This developer guide explains the setup and usage of our development environment using Visual Studio Code (VS Code) and Docker. The goal is to create a consistent and clean development environment that is easily reproducible and avoids polluting the host system with additional dependencies.

=== Rationale

 The setup adds makes the project less accessible as it requires docker on the system. I develop on a Windows system and see the following benefits that outweigh this dissadvantage: 

* *Desired functionality not accessible under Windows* +
  Some libraries or implementations might be not available under Windows. 

  ** The Windows Setup of the Pyhton library https://pyenchant.github.io/pyenchant/install.html#on-windows[Enchanted] requires some compromises limiting the support for non-english languages or complicating the overall setup.

* *The local setup is different from the setup in CI/CD and for production* +
  A close representation of environments your code will face during staging and production is crucial for an effective dev cycle. A different OS can often pose a challenge here compromising development quality. Linux is the OS of choice for the cloud and for web development however.

  ** Rust code oftentimes relies on OS specific implementations (e.g. implementing HTTPS in hyper)

* *Heavyweight dependencies* +
  Depending on a range of requirements (Tesseract_ORC, Python, a multitude of python libs sometimes requiring further dependencies like dictionarries) is assoicated with various probems: 
  
  ** Dev system and production system become hard to setup and to maintain

  ** code becomes clustered with local dependencies (user specific paths to resources) that have to be externalized.

=== Project Structure from inside and outside the development Container

These folders are made accessible for the container - they have the following purpouse

* *data* +
  store sample input files for development. 
  
* *Documentation (`/docs`)* +
  project documentation in asciidoc format. 
  
* *scripts (`/scripts/`)* +
  scripts for development (windows command shell and unix bash). 
  
* *Soruce Code (`/src/`)* +
  project source code. 
  
* *Target directory (`/target/`)* +
  build artifacts (incl. generated PDFs). 
  
* *Docker Setup (`/docker/`)* +
  dockerfiles for dev and production containers. 

* *VC Code Setup for Container development (/.devcontainer/)* +
  configuration of the develompent container for VS-Code. 

* *VC Code Setup for Container development (/.github/)* +
  configuration github pipelines. 
  
These folders are inaccessible for the container - you have to edit them locally
 
* *project root (/)*
  contains GITIGNORE and README.adoc

* "Readme resources (`/README/`)"
  contains resources associated with the README file (e.g. images)

If you want to make a new folder accessible to the container, it has to be lsited among the mount points in `/.devcontainer/devcontainer.json`. as long as the container side of the mout point is below `/workspace/` a change to the `Dockerfile` is not necessary.

=== Setup and Configuration of the Dev Containers

==== Prepare VS Code for Dev Containers

A https://code.visualstudio.com/docs/devcontainers/containers[descriiton of the concept] and a https://code.visualstudio.com/docs/devcontainers/tutorial[tutorial how to setup your editor] are found in the official documentation for VSCode.

The following description will point out specific points relevant to the project but does not aspire to provide an exhaustive explanation.

==== Dev Container Configuration

The `.devcontainer` directory contains configuration files for the VS Code Dev Container. The `devcontainer.json` file specifies how the container should be built and what directories should be mounted. 

Key settings in `devcontainer.json`:
- **dockerFile**: Points to the Dockerfile in the `docker` directory.
- **workspaceFolder**: Sets the working directory inside the container.
- **mounts**: Binds the local directories to the container directories.
- **settings**: Configures the terminal shell to use bash.
- **extensions**: Installs the necessary VS Code extensions inside the container.
- **postCreateCommand**: Installs the Python dependencies listed in `requirements.txt`.
- **remoteUser**: Sets the user as `root` to ensure necessary permissions.

====  Dockerfile

The Dockerfiles in the `/docker` directory sets up...

* ... a container to be used by VSCode as a dev environment (`Dockerfile`)
* ... a container to be used for the production build (`Dockerfile.prod`)

They have obviously things in common as they share many dependencies but the dev container starts up with bash while the productio version imediately calls our python script on startup.

//todo: clarifz paramters

====  Using the scripts during development

For typical development activities we developed shell-scripts, see `/scripts/`

Building and starting the development container is normally done by the IDE - you need these scripts, if you want to perform something directly on the comand line, not within the IDE.

you will need the bash (*.sh) or the windows shell (*.cmd) version of the script, depending on wether you are within the container or outside when you perform the action. Take care not to use windows powershell, since the scripts are optimised for the normal comand shell.

==== Managing the connection between the IDE and the development container 

The connection between the  IDE and the development container is managed by an https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-containers[extention]

* Start Docker Daemon (usually by starting Docker Desktop)
* Make sure the service is running:`docker info` (optional)
* Make sure there is no container lingering from the last session:`docker ps -a` (optional)
* Stop and remove a lingering container: `docker stop <container_id>` and `docker rm <container_id>`
* Open VS Code will start in local mode
* Switch to Container mode: `Str + Shift + P` and type "Dev Containers: Open Folder in Container"
* Switch back to Local mode `Str + Shift + P` and type "Dev Containers: Open Folder Locally"
* Perform a container restart, e.g. after a config change `Str + Shift + P` and type "Dev Containers: Reopen Folder Locally"
* Trouble-Shooting: If you get tangled. Stop VS Code and make sure there is no process running (Code), stop all containers and start afresh.

==== Adding Extentions to VSCode

If you install a new extension in VS Code while using a Dev Container, it will not automatically persist across container restarts or rebuilds unless specified in the devcontainer.json configuration. To ensure that the extension is always available in your Dev Container, you need to add it to the extensions list in your devcontainer.json. This can be done directly from the Marketplace view via the context menu.

You might also have to restart VS Code to complete the process.

==== Using Git and Dev Containers

===== Manage Git from Local Machine

====== Pros and Cons

* Pro
  ** simpler
  ** avoids the need to duplicate SSH key management in the container

====== Setup

. Generate or Use Existing SSH Keys: +

  If you donâ€™t already have SSH keys, generate them on your local machine:
[source, shell]
----------------
Copy code
ssh-keygen -t rsa -b 4096 -C "your_email@example.com"
----------------

. Add the SSH key to your GitHub account +

  Copying the public key content (~/.ssh/id_rsa.pub)

. Configure VS Code to Use Local Git

  When using VS Code on your local machine, it will use the SSH keys from your local .ssh directory.

===== Manage Git from Within the Container

====== Pros and Cons

* Pro
  ** more comfort and consistency
* Con
  ** SSH key management and git configuration in the container necessary

====== Implications

If we want to manage git from within the container it does not make sense anymore to rely on binding seleced folders in our project to the container because we need access to the project as a whole and `.gitignore` in particular, which resides in the (otherwise inaccessible) root dir. Instead we should mount the whole project directory in one go.

We have to store the ssh keys and they have to be in a location separate from the project.


====== Setup

*update Dockerfile*

....
# Use an official Ubuntu as a parent image
FROM ubuntu:latest

# Install required tools
RUN apt-get update && apt-get install -y \
    build-essential \
    curl \
    wget \
    git \
    vim \
    python3 \
    python3-pip \
    python3-venv \
    tesseract-ocr \
    asciidoctor \
    bash

# Set the working directory for the project
WORKDIR /workspace

# Create and activate a virtual environment
RUN python3 -m venv /workspace/venv

# Set environment variables for the virtual environment
ENV PATH="/workspace/venv/bin:$PATH"

# Create a separate directory for SSH keys
RUN mkdir /root/.ssh

# Run bash by default
CMD ["bash"]
....

*Update `devcontainer.json` to mount the ssh and the project as a whole and mount the ssh directory thus making the keys accessible in the container.*

....
 {
  "name": "Dev Container",
  "dockerFile": "../docker/Dockerfile",
  "workspaceFolder": "/workspace",
  "context": "..",
  "mounts": [
    "source=${localWorkspaceFolder},target=/workspace,type=bind",
    "source=${env:HOME}/.ssh,target=/root/.ssh,type=bind"
  ],
  "settings": {
    "terminal.integrated.shell.linux": "/bin/bash"
  },
  "extensions": [
    "ms-python.python",
    "ms-azuretools.vscode-docker",
    "GitHub.vscode-pull-request-github",
    "asciidoctor.asciidoctor-vscode"  // Add this line for AsciiDoc extension
  ],
  "postCreateCommand": "/workspace/venv/bin/pip install --no-cache-dir -r /workspace/requirements.txt",
  "remoteUser": "root"
}
....

*Configure ssh in the container*

Ensure the SSH configuration inside the container recognizes your keys:

....
eval "$(ssh-agent -s)"
ssh-add /root/.ssh/id_rsa
....

Test the SSH connection to GitHub:
....
ssh -T git@github.com
....


Using Git and SSH in VS Code
VS Code SSH Configuration:

If you are using VS Code locally with the Remote - Containers extension, it will use the SSH keys from your local .ssh directory.
If you are working inside a container, ensure the container has access to the SSH keys as described above.
VS Code Git Integration:

You can use the Source Control view in VS Code to perform Git operations.
Ensure the SSH key used for authentication is accessible (either from the local machine or within the container, depending on your setup).





