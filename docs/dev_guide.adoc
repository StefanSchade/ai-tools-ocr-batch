= Developer Guide

== Abstract



== Developing in a Container

This developer guide explains the setup and usage of our development environment using Visual Studio Code (VS Code) and Docker. The goal is to create a consistent and clean development environment that is easily reproducible and avoids polluting the host system with additional dependencies.

=== Rationale

 The setup adds makes the project less accessible as it requires docker on the system. I develop on a Windows system and see the following benefits that outweigh this dissadvantage: 

* *Desired functionality not accessible under Windows* +
  Some libraries or implementations might be not available under Windows. 

  ** The Windows Setup of the Pyhton library https://pyenchant.github.io/pyenchant/install.html#on-windows[Enchanted] requires some compromises limiting the support for non-english languages or complicating the overall setup.

* *The local setup is different from the setup in CI/CD and for production* +
  A close representation of environments your code will face during staging and production is crucial for an effective dev cycle. A different OS can often pose a challenge here compromising development quality. Linux is the OS of choice for the cloud and for web development however.

  ** Rust code oftentimes relies on OS specific implementations (e.g. implementing HTTPS in hyper)

* *Heavyweight dependencies* +
  Depending on a range of requirements (Tesseract_ORC, Python, a multitude of python libs sometimes requiring further dependencies like dictionarries) is assoicated with various probems: 
  
  ** Dev system and production system become hard to setup and to maintain

  ** code becomes clustered with local dependencies (user specific paths to resources) that have to be externalized.

=== Project Structure from inside and outside the development Container

These folders are made accessible for the container - they have the following purpouse

* *data* +
  store sample input files for development. 
  
* *Documentation (`/docs`)* +
  project documentation in asciidoc format. 
  
* *scripts (`/scripts/`)* +
  scripts for development (windows command shell and unix bash). 
  
* *Soruce Code (`/src/`)* +
  project source code. 
  
* *Target directory (`/target/`)* +
  build artifacts (incl. generated PDFs). 
  
* *Docker Setup (`/docker/`)* +
  dockerfiles for dev and production containers. 

* *VC Code Setup for Container development (/.devcontainer/)* +
  configuration of the develompent container for VS-Code. 

* *VC Code Setup for Container development (/.github/)* +
  configuration github pipelines. 
  
These folders are inaccessible for the container - you have to edit them locally
 
* *project root (/)*
  contains GITIGNORE and README.adoc

* "Readme resources (`/README/`)"
  contains resources associated with the README file (e.g. images)

If you want to make a new folder accessible to the container, it has to be lsited among the mount points in `/.devcontainer/devcontainer.json`. as long as the container side of the mout point is below `/workspace/` a change to the `Dockerfile` is not necessary.

=== Setup and Configuration of the Dev Containers

==== Prepare VS Code for Dev Containers

A https://code.visualstudio.com/docs/devcontainers/containers[descriiton of the concept] and a https://code.visualstudio.com/docs/devcontainers/tutorial[tutorial how to setup your editor] are found in the official documentation for VSCode.

The following description will point out specific points relevant to the project but does not aspire to provide an exhaustive explanation.

==== Dev Container Configuration

The `.devcontainer` directory contains configuration files for the VS Code Dev Container. The `devcontainer.json` file specifies how the container should be built and what directories should be mounted. 

Key settings in `devcontainer.json`:
- **dockerFile**: Points to the Dockerfile in the `docker` directory.
- **workspaceFolder**: Sets the working directory inside the container.
- **mounts**: Binds the local directories to the container directories.
- **settings**: Configures the terminal shell to use bash.
- **extensions**: Installs the necessary VS Code extensions inside the container.
- **postCreateCommand**: Installs the Python dependencies listed in `requirements.txt`.
- **remoteUser**: Sets the user as `root` to ensure necessary permissions.

====  Dockerfile

The Dockerfiles in the `/docker` directory sets up...

* ... a container to be used by VSCode as a dev environment (`Dockerfile`)
* ... a container to be used for the production build (`Dockerfile.prod`)

They have obviously things in common as they share many dependencies but the dev container starts up with bash while the productio version imediately calls our python script on startup.

//todo: clarifz paramters

====  Using the scripts during development

For typical development activities we developed shell-scripts, see `/scripts/`

Building and starting the development container is normally done by the IDE - you need these scripts, if you want to perform something directly on the comand line, not within the IDE.

you will need the bash (*.sh) or the windows shell (*.cmd) version of the script, depending on wether you are within the container or outside when you perform the action. Take care not to use windows powershell, since the scripts are optimised for the normal comand shell.

====  Managing the connection between the IDE and the development container 

The connection between the  IDE and the development container is managed by an https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-containers[extention]

* Start Docker Daemon (usually by starting Docker Desktop)
* Make sure the service is running:`docker info` (optional)
* Make sure there is no container lingering from the last session:`docker ps -a` (optional)
* Stop and remove a lingering container: `docker stop <container_id>` and `docker rm <container_id>`
* Open VS Code will start in local mode
* Switch to Container mode: `Str + Shift + P` and type "Dev Containers: Open Folder in Container"
* Switch back to Local mode `Str + Shift + P` and type "Dev Containers: Open Folder Locally"
* Perform a container restart, e.g. after a config change `Str + Shift + P` and type "Dev Containers: Reopen Folder Locally"
* Trouble-Shooting: If you get tangled. Stop VS Code and make sure there is no process running (Code), stop all containers and start afresh.

